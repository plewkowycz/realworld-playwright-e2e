name: E2E
on: 
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install e2e deps
        working-directory: e2e
        run: |
          npm ci || npm i

      - name: Prettier check
        working-directory: e2e
        run: npm run format:check

      - name: ESLint check
        working-directory: e2e
        run: npm run lint

  test:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install e2e deps
        working-directory: e2e
        run: |
          npm ci || npm i
          npx playwright install --with-deps

      - name: Clone or update app
        run: |
          [ -d app/.git ] || git clone https://github.com/NemTam/realworld-django-rest-framework-angular app
          git -C app pull --ff-only || true

      - name: Build app images
        run: docker compose -f app/docker-compose.yml build

      - name: Start app stack
        run: docker compose -f app/docker-compose.yml up -d

      - name: Wait for backend
        env:
          BACKEND_BASE_URL: ${{ vars.APP_API_URL }}
        run: |
          : "${APP_API_URL:?Set APP_API_URL in repository or environment variables}"
          for i in {1..300}; do
            if curl -sS -o /dev/null "$APP_API_URL/"; then exit 0; fi
            sleep 2
          done
          echo "Timeout waiting for backend ($APP_API_URL)" >&2
          exit 1

      - name: Wait for frontend
        working-directory: e2e
        env:
          APP_BASE_URL: ${{ vars.APP_BASE_URL }}
        run: |
          : "${APP_BASE_URL:?Set APP_BASE_URL in repository or environment variables}"
          for i in {1..300}; do
            if curl -sS -o /dev/null "$APP_BASE_URL/"; then exit 0; fi
            sleep 2
          done
          echo "Timeout waiting for frontend ($APP_BASE_URL)" >&2
          exit 1

      - name: Run smoke tests
        working-directory: e2e
        env:
          APP_BASE_URL: ${{ vars.APP_BASE_URL }}
        run: |
          : "${APP_BASE_URL:?Set APP_BASE_URL in repository or environment variables}"
          npx playwright test tests/smoke.spec.ts --reporter=github

      - name: Run Playwright tests (headless)
        working-directory: e2e
        env:
          APP_BASE_URL: ${{ vars.APP_BASE_URL }}
        run: |
          : "${APP_BASE_URL:?Set APP_BASE_URL in repository or environment variables}"
          npx playwright test --reporter=github

      - name: Tear down
        if: always()
        run: docker compose -f app/docker-compose.yml down -v

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report


